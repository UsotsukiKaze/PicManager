<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¸­å¿ƒ - PicManager</title>
    <link rel="icon" href="/static/icon/Pic.ico" type="image/x-icon">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .profile-container {
            min-height: 100vh;
            background: var(--bg-primary);
        }

        .profile-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .profile-header h1 {
            color: white;
            margin: 0;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .header-btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .header-btn.primary {
            background: white;
            color: var(--primary-color);
            border: none;
        }

        .header-btn.primary:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }

        .header-btn.danger {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header-btn.danger:hover {
            background: var(--danger-color);
            border-color: var(--danger-color);
        }

        .profile-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        .profile-tabs {
            display: flex;
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .profile-tab {
            flex: 1;
            padding: 14px 20px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .profile-tab:hover {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        .profile-tab.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .profile-tab.hidden {
            display: none;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        /* ä¸ªäººä¿¡æ¯å¡ç‰‡ */
        .user-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }

        .user-avatar-section {
            display: flex;
            align-items: center;
            gap: 25px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-color);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }

        .user-basic-info {
            flex: 1;
        }

        .user-nickname {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .user-qq {
            color: var(--text-secondary);
            font-size: 15px;
            margin: 0 0 10px 0;
        }

        .user-role-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .role-root {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .role-admin {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .role-user {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            color: white;
        }

        .role-guest {
            background: var(--text-muted);
            color: white;
        }

        .user-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }

        .stat-item {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 6px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* ä¿®æ”¹å¯†ç å¡ç‰‡ */
        .password-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .password-form {
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* ç®¡ç†å‘˜æ§åˆ¶å° */
        .admin-section {
            margin-bottom: 30px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .pending-count {
            background: var(--danger-color);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            margin-left: 10px;
        }

        .request-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .request-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .request-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .request-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }

        .request-user-info {
            display: flex;
            flex-direction: column;
        }

        .request-user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .request-user-qq {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .request-type {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
        }

        .type-add {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .type-edit {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .type-delete {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .request-content {
            background: var(--bg-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .request-image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .request-detail {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        /* Rootæ§åˆ¶å° - ç®¡ç†å‘˜ç®¡ç† */
        .admin-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .admin-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .admin-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .admin-info {
            flex: 1;
        }

        .admin-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .admin-qq {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .add-admin-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .add-admin-form {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .add-admin-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        /* æ¸¸å®¢ä¿¡æ¯ */
        .guest-card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .guest-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .guest-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .guest-ip {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .guest-limit-info {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .limit-progress {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .limit-bar {
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            transition: width 0.3s ease;
        }

        .limit-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body>
    <div class="profile-container">
        <div class="profile-header">
            <h1>
                <span class="inline-icon icon-user"></span>
                <span>ä¸ªäººä¸­å¿ƒ</span>
            </h1>
            <div class="header-actions">
                <a href="/" class="header-btn primary">è¿”å›ä¸»é¡µ</a>
                <button class="header-btn danger" onclick="handleLogout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <div class="profile-content">
            <div class="profile-tabs">
                <button class="profile-tab active" data-tab="personal">ä¸ªäººä¿¡æ¯</button>
                <button class="profile-tab hidden" id="admin-tab" data-tab="admin">ç®¡ç†å‘˜æ§åˆ¶å°</button>
                <button class="profile-tab hidden" id="root-tab" data-tab="root">Rootæ§åˆ¶å°</button>
            </div>

            <!-- ä¸ªäººä¿¡æ¯é¢æ¿ -->
            <div class="tab-panel active" id="personal-panel">
                <!-- æ¸¸å®¢è§†å›¾ -->
                <div class="guest-card" id="guest-view" style="display: none;">
                    <div class="guest-icon">ğŸ‘»</div>
                    <h2 class="guest-title">æ¸¸å®¢æ¨¡å¼</h2>
                    <p class="guest-ip">IPåœ°å€: <span id="guest-ip-display">--</span></p>
                    
                    <div class="guest-limit-info">
                        <div class="limit-progress">
                            <div class="limit-bar" id="limit-bar" style="width: 100%;"></div>
                        </div>
                        <p class="limit-text">ä»Šæ—¥å‰©ä½™æ“ä½œæ¬¡æ•°: <strong id="remaining-ops">5</strong> / 5</p>
                    </div>

                    <a href="/login" class="btn btn-primary">
                        ç™»å½•ä»¥è·å¾—å®Œæ•´åŠŸèƒ½
                    </a>
                </div>

                <!-- ç”¨æˆ·è§†å›¾ -->
                <div id="user-view" style="display: none;">
                    <div class="user-card">
                        <div class="user-avatar-section">
                            <img id="user-avatar" class="user-avatar" src="" alt="å¤´åƒ">
                            <div class="user-basic-info">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <h2 class="user-nickname" id="user-nickname">--</h2>
                                    <button class="btn btn-sm btn-secondary" id="refresh-nickname-btn" onclick="refreshNickname()" title="ä»QQå·è‡ªåŠ¨è·å–æ˜µç§°" style="padding: 4px 8px; font-size: 12px;">
                                        <span class="inline-icon icon-refresh"></span>
                                        <span>è‡ªåŠ¨</span>
                                    </button>
                                    <button class="btn btn-sm btn-secondary" id="edit-nickname-btn" onclick="toggleEditNickname()" title="æ‰‹åŠ¨ç¼–è¾‘æ˜µç§°" style="padding: 4px 8px; font-size: 12px;">
                                        <span class="inline-icon icon-edit"></span>
                                        <span>ç¼–è¾‘</span>
                                    </button>
                                </div>
                                <div id="edit-nickname-form" style="display: none; margin-top: 10px; gap: 8px;">
                                    <input type="text" id="new-nickname-input" class="form-input" placeholder="è¾“å…¥æ–°æ˜µç§°" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid var(--border-color);">
                                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                                        <button class="btn btn-sm btn-success" onclick="saveNickname()">ä¿å­˜</button>
                                        <button class="btn btn-sm btn-secondary" onclick="toggleEditNickname()">å–æ¶ˆ</button>
                                    </div>
                                </div>
                                <p class="user-qq">QQ: <span id="user-qq">--</span></p>
                                <span class="user-role-badge" id="user-role">--</span>
                            </div>
                        </div>
                        <div class="user-stats">
                            <div class="stat-item">
                                <div class="stat-value" id="stat-joined">--</div>
                                <div class="stat-label">æ³¨å†Œæ—¶é—´</div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¿®æ”¹å¯†ç ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰ -->
                    <div class="password-card" id="password-section" style="display: none;">
                        <h3 class="card-title">
                            <span class="inline-icon icon-lock"></span>
                            <span>ä¿®æ”¹å¯†ç </span>
                        </h3>
                        <div class="password-form">
                            <div class="form-group">
                                <label>åŸå¯†ç </label>
                                <input type="password" id="old-password" class="form-input" placeholder="è¯·è¾“å…¥åŸå¯†ç ">
                            </div>
                            <div class="form-group">
                                <label>æ–°å¯†ç </label>
                                <input type="password" id="new-password" class="form-input" placeholder="è¯·è¾“å…¥æ–°å¯†ç ">
                            </div>
                            <div class="form-group">
                                <label>ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="confirm-password" class="form-input" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                            </div>
                            <button class="btn btn-primary" onclick="changePassword()">ä¿®æ”¹å¯†ç </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç®¡ç†å‘˜æ§åˆ¶å°é¢æ¿ -->
            <div class="tab-panel" id="admin-panel">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">
                            å¾…å®¡æ ¸è¯·æ±‚
                            <span class="pending-count" id="pending-count">0</span>
                        </h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadPendingRequests()">
                            <span class="inline-icon icon-refresh"></span>
                            <span>åˆ·æ–°</span>
                        </button>
                    </div>
                    
                    <div class="request-list" id="request-list">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>æš‚æ— å¾…å®¡æ ¸è¯·æ±‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rootæ§åˆ¶å°é¢æ¿ -->
            <div class="tab-panel" id="root-panel">
                <div class="admin-section">
                    <div class="section-header">
                        <h2 class="section-title">ç®¡ç†å‘˜åˆ—è¡¨</h2>
                    </div>
                    
                    <div class="admin-list" id="admin-list">
                        <!-- ç®¡ç†å‘˜å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <div class="add-admin-card">
                        <h3 class="card-title">â• æ·»åŠ ç®¡ç†å‘˜</h3>
                        <div class="add-admin-form">
                            <div class="form-group">
                                <label>QQå·ç </label>
                                <input type="text" id="new-admin-qq" class="form-input" placeholder="è¾“å…¥QQå·ç ">
                            </div>
                            <button class="btn btn-primary" onclick="addAdmin()">æ·»åŠ </button>
                        </div>
                        <p style="margin-top: 12px; color: var(--text-secondary); font-size: 13px;">
                            * æ–°ç®¡ç†å‘˜çš„é»˜è®¤å¯†ç ä¸º: admin
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let currentUser = null;

        // Toasté€šçŸ¥
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.profile-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('hidden')) return;
                
                document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                
                tab.classList.add('active');
                document.getElementById(`${tab.dataset.tab}-panel`).classList.add('active');
                
                // åˆ‡æ¢åˆ°ç®¡ç†å‘˜é¢æ¿æ—¶åŠ è½½è¯·æ±‚
                if (tab.dataset.tab === 'admin') {
                    loadPendingRequests();
                }
                // åˆ‡æ¢åˆ°rooté¢æ¿æ—¶åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨
                if (tab.dataset.tab === 'root') {
                    loadAdminList();
                }
            });
        });

        // è·å–ç”¨æˆ·ä¿¡æ¯
        async function loadUserInfo() {
            try {
                const response = await fetch('/auth/me');
                if (!response.ok) {
                    window.location.href = '/login';
                    return;
                }

                const data = await response.json();

                if (data.is_guest) {
                    // æ¸¸å®¢è§†å›¾
                    document.getElementById('guest-view').style.display = 'block';
                    document.getElementById('user-view').style.display = 'none';
                    document.getElementById('guest-ip-display').textContent = data.guest_ip || '--';
                    document.getElementById('remaining-ops').textContent = data.remaining_operations;
                    
                    const percent = (data.remaining_operations / data.daily_limit) * 100;
                    document.getElementById('limit-bar').style.width = `${percent}%`;
                } else {
                    // ç”¨æˆ·è§†å›¾
                    currentUser = data.user;
                    document.getElementById('guest-view').style.display = 'none';
                    document.getElementById('user-view').style.display = 'block';
                    
                    document.getElementById('user-avatar').src = currentUser.avatar_url || '';
                    document.getElementById('user-nickname').textContent = currentUser.nickname || '--';
                    document.getElementById('user-qq').textContent = currentUser.qq_number;
                    
                    const roleEl = document.getElementById('user-role');
                    const roleMap = {
                        'root': { text: 'Rootç®¡ç†å‘˜', class: 'role-root' },
                        'admin': { text: 'ç®¡ç†å‘˜', class: 'role-admin' },
                        'user': { text: 'æ™®é€šç”¨æˆ·', class: 'role-user' }
                    };
                    const roleInfo = roleMap[currentUser.role] || { text: 'æ™®é€šç”¨æˆ·', class: 'role-user' };
                    roleEl.textContent = roleInfo.text;
                    roleEl.className = `user-role-badge ${roleInfo.class}`;

                    // æ ¼å¼åŒ–æ³¨å†Œæ—¶é—´
                    const joinDate = new Date(currentUser.created_at);
                    document.getElementById('stat-joined').textContent = 
                        joinDate.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' });

                    // æ˜¾ç¤ºç®¡ç†å‘˜ä¸“å±åŠŸèƒ½
                    if (currentUser.role === 'root' || currentUser.role === 'admin') {
                        document.getElementById('password-section').style.display = 'block';
                        document.getElementById('admin-tab').classList.remove('hidden');
                    }

                    // æ˜¾ç¤ºRootä¸“å±åŠŸèƒ½
                    if (currentUser.role === 'root') {
                        document.getElementById('root-tab').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('Failed to load user info:', error);
                window.location.href = '/login';
            }
        }

        // åˆ‡æ¢æ˜µç§°ç¼–è¾‘æ¨¡å¼
        function toggleEditNickname() {
            const form = document.getElementById('edit-nickname-form');
            const input = document.getElementById('new-nickname-input');
            
            if (form.style.display === 'none') {
                form.style.display = 'flex';
                input.value = document.getElementById('user-nickname').textContent;
                input.focus();
            } else {
                form.style.display = 'none';
            }
        }

        // ä¿å­˜æ–°æ˜µç§°
        async function saveNickname() {
            const newNickname = document.getElementById('new-nickname-input').value.trim();
            
            if (!newNickname) {
                showToast('æ˜µç§°ä¸èƒ½ä¸ºç©º', 'error');
                return;
            }
            
            try {
                const response = await fetch('/auth/set-nickname', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname: newNickname })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'ä¿å­˜å¤±è´¥');
                }

                const user = data.user;
                document.getElementById('user-nickname').textContent = user.nickname;
                showToast(data.message);
                toggleEditNickname();
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ·æ–°QQæ˜µç§°
        async function refreshNickname() {
            try {
                const btn = document.getElementById('refresh-nickname-btn');
                btn.disabled = true;
                btn.textContent = 'åˆ·æ–°ä¸­...';

                const response = await fetch('/auth/refresh-nickname', {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('åˆ·æ–°å¤±è´¥');
                }

                const data = await response.json();
                const user = data.user;

                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                document.getElementById('user-nickname').textContent = user.nickname;
                document.getElementById('user-avatar').src = user.avatar_url;

                showToast('æ˜µç§°å·²æ›´æ–°: ' + user.nickname);
                
                btn.textContent = 'è‡ªåŠ¨';
                btn.disabled = false;
            } catch (error) {
                showToast('åˆ·æ–°å¤±è´¥: ' + error.message, 'error');
                document.getElementById('refresh-nickname-btn').textContent = 'è‡ªåŠ¨';
                document.getElementById('refresh-nickname-btn').disabled = false;
            }
        }

        // ä¿®æ”¹å¯†ç 
        async function changePassword() {
            const oldPassword = document.getElementById('old-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!oldPassword || !newPassword || !confirmPassword) {
                showToast('è¯·å¡«å†™æ‰€æœ‰å­—æ®µ', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            if (newPassword.length < 4) {
                showToast('æ–°å¯†ç é•¿åº¦è‡³å°‘4ä½', 'error');
                return;
            }

            try {
                const response = await fetch('/auth/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        old_password: oldPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'ä¿®æ”¹å¤±è´¥');
                }

                showToast('å¯†ç ä¿®æ”¹æˆåŠŸ');
                document.getElementById('old-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // åŠ è½½å¾…å®¡æ ¸è¯·æ±‚
        async function loadPendingRequests() {
            try {
                const response = await fetch('/admin/pending');
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const requests = await response.json();
                document.getElementById('pending-count').textContent = requests.length;

                const container = document.getElementById('request-list');
                
                if (requests.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>æš‚æ— å¾…å®¡æ ¸è¯·æ±‚</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = requests.map(req => {
                    const typeMap = {
                        'add': { text: 'æ·»åŠ å›¾ç‰‡', class: 'type-add' },
                        'edit': { text: 'ç¼–è¾‘å›¾ç‰‡', class: 'type-edit' },
                        'delete': { text: 'åˆ é™¤å›¾ç‰‡', class: 'type-delete' },
                        'group_add': { text: 'æ·»åŠ åˆ†ç»„', class: 'type-add' },
                        'group_edit': { text: 'ç¼–è¾‘åˆ†ç»„', class: 'type-edit' },
                        'group_delete': { text: 'åˆ é™¤åˆ†ç»„', class: 'type-delete' },
                        'character_add': { text: 'æ·»åŠ è§’è‰²', class: 'type-add' },
                        'character_edit': { text: 'ç¼–è¾‘è§’è‰²', class: 'type-edit' },
                        'character_delete': { text: 'åˆ é™¤è§’è‰²', class: 'type-delete' }
                    };
                    const typeInfo = typeMap[req.request_type] || { text: req.request_type, class: '' };

                    const avatar = req.user_avatar || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%23ccc"/></svg>';
                    const userName = req.user_nickname || req.user_qq || `æ¸¸å®¢(${req.guest_ip})`;
                    const userQQ = req.user_qq || req.guest_ip;

                    let contentHtml = '';
                    if (req.temp_file_path && req.request_type === 'add') {
                        const filename = req.temp_file_path.split(/[/\\]/).pop();
                        contentHtml = `
                            <img src="/resource/pending/${filename}" class="request-image-preview" alt="é¢„è§ˆå›¾" onerror="this.style.display='none'">
                            <div class="request-detail">
                                <strong>åŸå§‹æ–‡ä»¶å:</strong> ${req.original_filename || '--'}<br>
                                ${req.image_data ? `
                                    <strong>åˆ†ç»„:</strong> ${req.group_info ? req.group_info.name : 'æœªé€‰æ‹©'}<br>
                                    <strong>è§’è‰²:</strong> ${req.character_names && req.character_names.length > 0 ? req.character_names.join(', ') : 'æœªé€‰æ‹©'}<br>
                                    <strong>PID:</strong> ${req.image_data.pid || '--'}<br>
                                    <strong>æè¿°:</strong> ${req.image_data.description || '--'}
                                ` : '--'}
                            </div>
                        `;
                    } else if (req.request_type === 'edit') {
                        let originalImageHtml = '';
                        if (req.original_image) {
                            originalImageHtml = `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <strong style="color: #666;">ã€åŸå›¾ä¿¡æ¯ã€‘</strong><br>
                                    <strong>åŸPID:</strong> ${req.original_image.pid || '--'}<br>
                                    <strong>åŸæè¿°:</strong> ${req.original_image.description || '--'}<br>
                                    <strong>åŸè§’è‰²:</strong> ${req.original_image.character_names && req.original_image.character_names.length > 0 ? req.original_image.character_names.join(', ') : '--'}<br>
                                    <div style="margin-top: 10px;">
                                        <img src="/resource/store/${req.original_image.image_id}.${req.original_image.file_extension}" 
                                             class="request-image-preview" alt="åŸå›¾" onerror="this.style.display='none'">
                                    </div>
                                </div>
                            `;
                        }
                        contentHtml = `
                            <div class="request-detail">
                                <strong>å›¾ç‰‡ID:</strong> ${req.image_id || '--'}<br>
                                ${req.image_data ? `
                                    <strong>æ–°åˆ†ç»„:</strong> ${req.group_info ? req.group_info.name : '(ä¸å˜)'}<br>
                                    <strong>æ–°è§’è‰²:</strong> ${req.character_names && req.character_names.length > 0 ? req.character_names.join(', ') : '(ä¸å˜)'}<br>
                                    <strong>æ–°PID:</strong> ${req.image_data.pid || '(ä¸å˜)'}<br>
                                    <strong>æ–°æè¿°:</strong> ${req.image_data.description || '(ä¸å˜)'}
                                ` : '--'}
                                ${originalImageHtml}
                            </div>
                        `;
                    } else if (req.request_type === 'delete') {
                        let originalImageHtml = '';
                        if (req.original_image) {
                            originalImageHtml = `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                                    <strong style="color: #666;">ã€åŸå›¾ä¿¡æ¯ã€‘</strong><br>
                                    <strong>åŸPID:</strong> ${req.original_image.pid || '--'}<br>
                                    <strong>åŸæè¿°:</strong> ${req.original_image.description || '--'}<br>
                                    <strong>åŸè§’è‰²:</strong> ${req.original_image.character_names && req.original_image.character_names.length > 0 ? req.original_image.character_names.join(', ') : '--'}<br>
                                    <div style="margin-top: 10px;">
                                        <img src="/resource/store/${req.original_image.image_id}.${req.original_image.file_extension}" 
                                             class="request-image-preview" alt="åŸå›¾" onerror="this.style.display='none'">
                                    </div>
                                </div>
                            `;
                        }
                        contentHtml = `
                            <div class="request-detail">
                                <strong>è¯·æ±‚åˆ é™¤å›¾ç‰‡ID:</strong> ${req.image_id || '--'}<br>
                                <em style="color: var(--warning-color);">* æ‰¹å‡†åè¯¥å›¾ç‰‡å°†è¢«åˆ é™¤</em>
                                ${originalImageHtml}
                            </div>
                        `;
                    } else if (req.request_type === 'group_add') {
                        contentHtml = `
                            <div class="request-detail">
                                <strong>åˆ†ç»„åç§°:</strong> ${req.group_info ? req.group_info.name : '--'}<br>
                                <strong>æè¿°:</strong> ${req.image_data ? req.image_data.description || '--' : '--'}
                            </div>
                        `;
                    } else if (req.request_type === 'group_edit') {
                        const originalGroup = req.original_group || {};
                        contentHtml = `
                            <div class="request-detail">
                                <strong>åˆ†ç»„ID:</strong> ${req.image_data ? req.image_data.group_id || '--' : '--'}<br>
                                <strong>æ–°åç§°:</strong> ${req.image_data ? req.image_data.name || '(ä¸å˜)' : '--'}<br>
                                <strong>æ–°æè¿°:</strong> ${req.image_data ? req.image_data.description || '(ä¸å˜)' : '--'}<br>
                                <div style="margin-top: 10px; color: #666;">
                                    <strong>åŸåˆ†ç»„:</strong> ${originalGroup.name || '--'}<br>
                                    <strong>åŸæè¿°:</strong> ${originalGroup.description || '--'}
                                </div>
                            </div>
                        `;
                    } else if (req.request_type === 'group_delete') {
                        const originalGroup = req.original_group || {};
                        contentHtml = `
                            <div class="request-detail">
                                <strong>è¯·æ±‚åˆ é™¤åˆ†ç»„ID:</strong> ${req.image_data ? req.image_data.group_id || '--' : '--'}<br>
                                <strong>åˆ†ç»„åç§°:</strong> ${originalGroup.name || '--'}<br>
                                <em style="color: var(--warning-color);">* æ‰¹å‡†åè¯¥åˆ†ç»„å°†è¢«åˆ é™¤</em>
                            </div>
                        `;
                    } else if (req.request_type === 'character_add') {
                        const charInfo = req.character_info || {};
                        contentHtml = `
                            <div class="request-detail">
                                <strong>è§’è‰²åç§°:</strong> ${charInfo.name || '--'}<br>
                                <strong>æ‰€å±åˆ†ç»„:</strong> ${charInfo.group_name || '--'}<br>
                                <strong>æ˜µç§°:</strong> ${(charInfo.nicknames && charInfo.nicknames.length) ? charInfo.nicknames.join(', ') : '--'}<br>
                                <strong>æè¿°:</strong> ${charInfo.description || '--'}
                            </div>
                        `;
                    } else if (req.request_type === 'character_edit') {
                        const charInfo = req.character_info || {};
                        const originalChar = req.original_character || {};
                        contentHtml = `
                            <div class="request-detail">
                                <strong>è§’è‰²ID:</strong> ${req.image_data ? req.image_data.character_id || '--' : '--'}<br>
                                <strong>æ–°åç§°:</strong> ${charInfo.name || '(ä¸å˜)'}<br>
                                <strong>æ–°åˆ†ç»„:</strong> ${charInfo.group_name || '(ä¸å˜)'}<br>
                                <strong>æ–°æ˜µç§°:</strong> ${(charInfo.nicknames && charInfo.nicknames.length) ? charInfo.nicknames.join(', ') : '(ä¸å˜)'}<br>
                                <strong>æ–°æè¿°:</strong> ${charInfo.description || '(ä¸å˜)'}
                                <div style="margin-top: 10px; color: #666;">
                                    <strong>åŸè§’è‰²:</strong> ${originalChar.name || '--'}<br>
                                    <strong>åŸåˆ†ç»„:</strong> ${originalChar.group_name || '--'}<br>
                                    <strong>åŸæ˜µç§°:</strong> ${(originalChar.nicknames && originalChar.nicknames.length) ? originalChar.nicknames.join(', ') : '--'}<br>
                                    <strong>åŸæè¿°:</strong> ${originalChar.description || '--'}
                                </div>
                            </div>
                        `;
                    } else if (req.request_type === 'character_delete') {
                        const originalChar = req.original_character || {};
                        contentHtml = `
                            <div class="request-detail">
                                <strong>è¯·æ±‚åˆ é™¤è§’è‰²ID:</strong> ${req.image_data ? req.image_data.character_id || '--' : '--'}<br>
                                <strong>è§’è‰²åç§°:</strong> ${originalChar.name || '--'}<br>
                                <strong>æ‰€å±åˆ†ç»„:</strong> ${originalChar.group_name || '--'}<br>
                                <em style="color: var(--warning-color);">* æ‰¹å‡†åè¯¥è§’è‰²å°†è¢«åˆ é™¤</em>
                            </div>
                        `;
                    }

                    if (!contentHtml) {
                        const raw = req.image_data ? JSON.stringify(req.image_data, null, 2) : '--';
                        contentHtml = `
                            <div class="request-detail">
                                <strong>è¯·æ±‚å†…å®¹:</strong>
                                <pre style="white-space: pre-wrap; margin-top: 8px;">${raw}</pre>
                            </div>
                        `;
                    }

                    return `
                        <div class="request-card">
                            <div class="request-header">
                                <div class="request-user">
                                    <img src="${avatar}" class="request-avatar" alt="å¤´åƒ">
                                    <div class="request-user-info">
                                        <span class="request-user-name">${userName}</span>
                                        <span class="request-user-qq">${userQQ}</span>
                                    </div>
                                </div>
                                <span class="request-type ${typeInfo.class}">${typeInfo.text}</span>
                            </div>
                            <div class="request-content">
                                ${contentHtml}
                            </div>
                            <div class="request-actions">
                                <button class="btn btn-danger btn-sm" onclick="handleRequest(${req.id}, 'reject')">æ‹’ç»</button>
                                <button class="btn btn-success btn-sm" onclick="handleRequest(${req.id}, 'approve')">æ‰¹å‡†</button>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load pending requests:', error);
                showToast('åŠ è½½å¾…å®¡æ ¸è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        // å¤„ç†å®¡æ ¸è¯·æ±‚
        async function handleRequest(requestId, action) {
            try {
                const response = await fetch(`/admin/pending/${requestId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'æ“ä½œå¤±è´¥');
                }

                showToast(data.message);
                loadPendingRequests();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨
        async function loadAdminList() {
            try {
                const response = await fetch('/admin/admins');
                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const admins = await response.json();
                const container = document.getElementById('admin-list');

                container.innerHTML = admins.map(admin => {
                    const isRoot = admin.role === 'root';
                    const avatar = admin.avatar_url || `https://q1.qlogo.cn/g?b=qq&nk=${admin.qq_number}&s=640`;
                    
                    return `
                        <div class="admin-card">
                            <img src="${avatar}" class="admin-avatar" alt="å¤´åƒ">
                            <div class="admin-info">
                                <div class="admin-name">${admin.nickname || admin.qq_number}</div>
                                <div class="admin-qq">QQ: ${admin.qq_number}</div>
                                <span class="user-role-badge ${isRoot ? 'role-root' : 'role-admin'}">
                                    ${isRoot ? 'Root' : 'ç®¡ç†å‘˜'}
                                </span>
                            </div>
                            ${!isRoot ? `
                                <button class="btn btn-danger btn-xs" onclick="removeAdmin('${admin.qq_number}')">
                                    ç§»é™¤
                                </button>
                            ` : ''}
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load admin list:', error);
                showToast('åŠ è½½ç®¡ç†å‘˜åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ·»åŠ ç®¡ç†å‘˜
        async function addAdmin() {
            const qq = document.getElementById('new-admin-qq').value.trim();

            if (!qq) {
                showToast('è¯·è¾“å…¥QQå·ç ', 'error');
                return;
            }

            if (!/^\d{5,12}$/.test(qq)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„QQå·ç ', 'error');
                return;
            }

            try {
                const response = await fetch('/admin/admins', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qq_number: qq })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'æ·»åŠ å¤±è´¥');
                }

                showToast(data.message);
                document.getElementById('new-admin-qq').value = '';
                loadAdminList();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // ç§»é™¤ç®¡ç†å‘˜
        async function removeAdmin(qq) {
            if (!confirm(`ç¡®å®šè¦ç§»é™¤ç®¡ç†å‘˜ ${qq} å—ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/admins/${qq}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'ç§»é™¤å¤±è´¥');
                }

                showToast(data.message);
                loadAdminList();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        async function handleLogout() {
            try {
                await fetch('/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                window.location.href = '/login';
            }
        }

        // é¡µé¢åŠ è½½
        loadUserInfo();
    </script>
</body>
</html>
